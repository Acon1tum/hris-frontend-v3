<div class="job-portal-management-flex">
  <div class="job-portal-management-container sticky-left-panel">
    <h1>Job Portal Management</h1>
    <p>Admins can add, edit, or remove job cards for the public job application portal.</p>
    
    <!-- Error and Success Messages -->
    <div *ngIf="errorMessage" class="error-message">
      {{ errorMessage }}
    </div>
    <div *ngIf="successMessage" class="success-message">
      {{ successMessage }}
    </div>
    
    <div class="job-management-actions">
      <button class="add-job-btn" (click)="onAddNewJob()" [disabled]="loading">
        <span *ngIf="loading" class="loading-spinner"></span>
        + Add New Job
      </button>
    </div>
    
    <!-- Search Bar -->
    <div class="search-container">
      <input 
        type="text" 
        [(ngModel)]="searchTerm" 
        placeholder="Search jobs..."
        (keyup.enter)="onSearch()"
        class="search-input"
      />
      <button (click)="onSearch()" class="search-btn">Search</button>
    </div>
    
    <div class="job-total-count">Total Jobs: {{ totalJobs }}</div>
    <div class="job-status-counts">
      <span>Draft: {{ postingStatusCounts['Draft'] || 0 }}</span>
      <span class="divider">|</span>
      <span>Published: {{ postingStatusCounts['Published'] || 0 }}</span>
      <span class="divider">|</span>
      <span>Closed: {{ postingStatusCounts['Closed'] || 0 }}</span>
      <span class="divider">|</span>
      <span>Filled: {{ postingStatusCounts['Filled'] || 0 }}</span>
    </div>
  </div>

  <div class="job-cards-panel">
    <!-- Loading State -->
    <div *ngIf="loading && jobs.length === 0" class="loading-state">
      <div class="loading-spinner"></div>
      <p>Loading job postings...</p>
    </div>
    
    <!-- Job Cards -->
    <ng-container *ngIf="!loading && filteredJobs.length > 0; else noJobs">
      <div class="job-card-admin" *ngFor="let job of filteredJobs; let i = index">
        <div class="job-card-header-admin">
          <div class="job-title-admin">{{ job.position_title }}</div>
          <span class="job-status-admin" [ngClass]="{
            'draft': job.posting_status === 'Draft',
            'published': job.posting_status === 'Published',
            'closed': job.posting_status === 'Closed',
            'filled': job.posting_status === 'Filled'
          }">{{ job.posting_status }}</span>
        </div>
        <div class="job-meta-admin">
          <span><b>Department:</b> {{ getDepartmentName(job.department_id) }}</span>
          <span><b>Type:</b> {{ job.employment_type }}</span>
          <span><b>Vacancies:</b> {{ job.num_vacancies }}</span>
          <span *ngIf="job.salary_range"><b>Salary:</b> {{ getSalaryRangeDisplay(job.salary_range) }}</span>
        </div>
        <div class="job-desc-admin">
          <b>Description:</b> {{ job.job_description | slice:0:150 }}{{ job.job_description.length > 150 ? '...' : '' }}
        </div>
        <div class="job-actions-admin">
          <!-- Status Update Dropdown -->
          <select 
            [value]="job.posting_status" 
            (change)="onStatusChange(job, $event)"
            class="status-select"
            [disabled]="loading"
          >
            <option value="Draft">Draft</option>
            <option value="Published">Published</option>
            <option value="Closed">Closed</option>
            <option value="Filled">Filled</option>
          </select>
          
          <!-- Loading indicator for status update -->
          <span *ngIf="loading" class="status-loading-spinner"></span>
          
          <button class="edit-btn" (click)="onEditJob(job)" aria-label="Edit job" [disabled]="loading">
            <span class="material-symbols-outlined">edit</span>
          </button>
          <button class="delete-btn" (click)="onDeleteJob(job)" aria-label="Delete job" [disabled]="loading">
            <span class="material-symbols-outlined">delete</span>
          </button>
        </div>
      </div>
    </ng-container>
    
    <ng-template #noJobs>
      <div class="no-jobs-state">
        <p *ngIf="!loading">No job postings found. Create your first job posting!</p>
      </div>
    </ng-template>
    
    <!-- Pagination -->
    <div *ngIf="totalPages > 1" class="pagination">
      <button 
        (click)="onPageChange(currentPage - 1)" 
        [disabled]="currentPage === 1 || loading"
        class="pagination-btn"
      >
        Previous
      </button>
      
      <span *ngFor="let page of getPageNumbers()" 
            (click)="onPageChange(page)"
            [class.active]="page === currentPage"
            class="page-number">
        {{ page }}
      </span>
      
      <button 
        (click)="onPageChange(currentPage + 1)" 
        [disabled]="currentPage === totalPages || loading"
        class="pagination-btn"
      >
        Next
      </button>
    </div>
  </div>
</div>

<!-- Place modal here, outside the main flex container -->
<div *ngIf="showForm" class="job-form-modal-overlay" tabindex="-1" aria-modal="true" role="dialog" aria-labelledby="jobFormTitle">
  <div class="job-form-modal-card" tabindex="0">
    <form (ngSubmit)="onSubmitJob()" #jobForm="ngForm" class="job-form">
      <div class="modal-header sticky-header-bar">
        <div>
          <h2 id="jobFormTitle">{{ isEdit ? 'Edit Job Posting' : 'Add New Job Posting' }}</h2>
          <div class="modal-subtitle">Fill out the details below to {{ isEdit ? 'update' : 'create' }} a job posting.</div>
        </div>
        <button type="button" class="close-modal-btn" aria-label="Close" (click)="onCancel()" [disabled]="loading">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      
      <!-- Form Error/Success Messages -->
      <div *ngIf="errorMessage" class="form-error-message">
        {{ errorMessage }}
      </div>
      <div *ngIf="successMessage" class="form-success-message">
        {{ successMessage }}
      </div>
      
      <div class="job-form-fields">
        <div class="form-section">
          <h3>Job Details</h3>
          <div class="form-row">
            <label for="position_title">Position Title *</label>
            <input 
              id="position_title" 
              type="text" 
              [(ngModel)]="jobPosting.position_title" 
              name="position_title" 
              required 
              placeholder="e.g. Software Engineer"
              [disabled]="loading"
            />
          </div>
          <div class="form-row">
            <label for="department_id">Department *</label>
            <select 
              id="department_id" 
              [(ngModel)]="jobPosting.department_id" 
              name="department_id" 
              required
              [disabled]="loading"
            >
              <option value="" disabled selected>Select department</option>
              <option *ngFor="let dept of departments" [value]="dept.id">{{ dept.department_name }}</option>
            </select>
          </div>
          <div class="form-row">
            <label for="job_description">Job Description *</label>
            <textarea 
              id="job_description" 
              [(ngModel)]="jobPosting.job_description" 
              name="job_description" 
              required 
              placeholder="Describe the job responsibilities..."
              rows="4"
              [disabled]="loading"
            ></textarea>
          </div>
          <div class="form-row">
            <label for="qualifications">Qualifications *</label>
            <textarea 
              id="qualifications" 
              [(ngModel)]="jobPosting.qualifications" 
              name="qualifications" 
              required 
              placeholder="List required qualifications..."
              rows="4"
              [disabled]="loading"
            ></textarea>
          </div>
          <div class="form-row">
            <label for="technical_competencies">Technical Competencies</label>
            <textarea 
              id="technical_competencies" 
              [(ngModel)]="jobPosting.technical_competencies" 
              name="technical_competencies" 
              placeholder="List technical skills..."
              rows="3"
              [disabled]="loading"
            ></textarea>
          </div>
        </div>
        <div class="form-section">
          <h3>Job Settings</h3>
          <div class="form-row">
            <label for="salary_range">Salary Range</label>
            <select 
              id="salary_range" 
              [(ngModel)]="jobPosting.salary_range" 
              name="salary_range"
              [disabled]="loading"
            >
              <option value="" selected>Select salary range</option>
              <option *ngFor="let range of salaryRanges" [value]="range.id">{{ range.range }}</option>
            </select>
          </div>
          <div class="form-row">
            <label for="employment_type">Employment Type *</label>
            <select 
              id="employment_type" 
              [(ngModel)]="jobPosting.employment_type" 
              name="employment_type" 
              required
              [disabled]="loading"
            >
              <option value="" disabled selected>Select type</option>
              <option value="Regular">Regular</option>
              <option value="Contractual">Contractual</option>
              <option value="Part_time">Part-time</option>
              <option value="Temporary">Temporary</option>
              <option value="Consultant">Consultant</option>
            </select>
          </div>
          <div class="form-row">
            <label for="num_vacancies">Number of Vacancies *</label>
            <input 
              id="num_vacancies" 
              type="number" 
              [(ngModel)]="jobPosting.num_vacancies" 
              name="num_vacancies" 
              min="1" 
              required 
              placeholder="e.g. 3"
              [disabled]="loading"
            />
          </div>
          <div class="form-row">
            <label for="application_deadline">Application Deadline *</label>
            <input 
              id="application_deadline" 
              type="date" 
              [(ngModel)]="jobPosting.application_deadline" 
              name="application_deadline" 
              required
              [disabled]="loading"
            />
          </div>
          <div class="form-row">
            <label for="posting_status">Posting Status *</label>
            <select 
              id="posting_status" 
              [(ngModel)]="jobPosting.posting_status" 
              name="posting_status" 
              required
              [disabled]="loading"
            >
              <option value="Draft">Draft</option>
              <option value="Published">Published</option>
              <option value="Closed">Closed</option>
              <option value="Filled">Filled</option>
            </select>
          </div>
        </div>
      </div>
      <div class="form-actions sticky-action-bar">
        <button 
          type="submit" 
          class="save-btn" 
          [disabled]="!jobForm.form.valid || loading"
        >
          <span *ngIf="loading" class="loading-spinner"></span>
          {{ isEdit ? 'Update' : 'Create' }} Job Posting
        </button>
        <button 
          type="button" 
          class="cancel-btn" 
          (click)="onCancel()"
          [disabled]="loading"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>
</div> 